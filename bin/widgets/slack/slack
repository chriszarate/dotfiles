#!/usr/bin/env bash

current_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cache_file="$current_dir/cache"
error_file="$current_dir/error"
token_file="$current_dir/token"

err() {
	echo "$1" | tee "$error_file"
	exit 1
}

get_slack_status() {
	local api
	local dms
	local mentions
	local status
	local token
	local total

	token="$1"

	if ! jq --version >/dev/null 2>&1; then
		err "jq not installed"
	fi

	if [[ -z $token ]]; then
		err "missing token"
	fi

	api="https://slack.com/api/users.counts"
	status="$(curl -s -d "token=$token" $api)"

	case "$(echo "$status" | jq -r '.error')" in
		null)
			;;
		not_authed)
			err "auth error"
			;;
		invalid_auth)
			err "auth error"
			;;
		account_inactive)
			err "auth error"
			;;
		*)
			err "Unknown error: $status"
			;;
	esac

	dms="$(echo "$status" | jq "[.ims[].dm_count] | add")"
	mentions="$(echo "$status" | jq "[.groups + .channels | . -map(select(.is_archived)) | .[].mention_count_display] | add")"
	total=$((dms + mentions))

	if [[ $total -gt 0 ]]; then
		echo "ï†˜ $total"
	fi
}

main() {
	local cache_ttl
	local now
	local mod

	cache_ttl=60

	if [[ -f "$error_file" ]]; then
		echo "check error file"
		exit 1
	fi

	if [[ ! -f "$token_file" ]]; then
		err "missing token"
	fi

	if [[ -f "$cache_file" ]]; then
		now=$(date +%s)
		mod=$(date -r "$cache_file" +%s)
		if [[ $(( now - mod )) -gt $cache_ttl ]]; then
			rm "$cache_file"
		fi
	fi

	if [[ ! -f "$cache_file" ]]; then
		get_slack_status "$(cat "$token_file")" > "$cache_file"
	fi

	cat "$cache_file"
}

main
