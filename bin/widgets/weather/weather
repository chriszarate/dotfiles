#!/usr/bin/env bash

# Get current weather from wttr.in.

get_weather() {
	local format

	format="%C+%t"

	curl -s "https://wttr.in/?format=$format" | sed -e 's/°F/°/' -e 's/+//' -e 's/\s+$//' | tr '[:upper:]' '[:lower:]'
}

main() {
	local cache_file
	local cache_ttl
	local current_dir
	local now
	local mod

	current_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
	cache_file="$current_dir/cache"
	cache_ttl=900

	if [[ -f "$cache_file" ]]; then
		now=$(date +%s)
		mod=$(date -r "$cache_file" +%s)
		if [[ $(( now - mod )) -gt $cache_ttl ]]; then
			rm "$cache_file"
			exit 0
		fi
	fi

	if [[ ! -f "$cache_file" ]]; then
		get_weather > "$cache_file"
	fi

	cat "$cache_file"
}

main
