#!/usr/bin/env bash

# Get current weather from wttr.in.

get_weather() {
	local format

	format="%C+%t"

	curl -s "https://wttr.in/?format=$format" | sed -e 's/°F/°/' -e 's/+//' -e 's/\s+$//' | tr '[:upper:]' '[:lower:]'
}

main() {
	local cache_file
	local cache_ttl
	local current_dir
	local mod
	local now
	local weather
	local weather_updated

	current_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
	cache_file="$current_dir/cache"
	cache_ttl=900

	if [[ -f "$cache_file" ]]; then
		weather="$(cat "$cache_file")"

		now=$(date +%s)
		mod=$(date -r "$cache_file" +%s)
		if [[ $(( now - mod )) -gt $cache_ttl ]]; then
			rm "$cache_file"
		fi
	fi

	if [[ ! -f "$cache_file" ]]; then
		weather_updated="$(get_weather)"

		if [ -n "$weather_updated" ]; then
			weather="$weather_updated"
			echo "$weather" > "$cache_file"
		fi
	fi

	echo "$weather"
}

main
