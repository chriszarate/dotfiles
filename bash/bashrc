## Exports
export EDITOR=vim


## Prompt
export PS1='\w\[\033[1;33m\]$(parse_git_status)\[\033[0m\]$ '


## Functions

# Get git repository status in shorthand form (branch name and cleanliness).
function parse_git_status () {
  git status -b --porcelain 2>/dev/null | awk -F'[#\./ ]+' '{print $2}' |
  while read statusline; do
    if [[ -n "$git_has_branch" && -n "$statusline" ]]; then
      printf "\033[35mâŒ¾"
      break
    fi
    printf "â‡ $statusline" && git_has_branch="yes"
  done
}

# Open SSH sessions in new tmux window and connect to a nested tmux session.
function tmux_ssh () {
  if [ -n "$2" ]; then
    ssh "$@"
  else
    tmux new-window -n "$1" """ssh -t "$1" '(command -v tmux >/dev/null 2>&1 && (tmux attach || tmux new-session -s ssh)) || bash -l'"""
  fi
}
alias ssh="tmux_ssh"

# Change to directory of the frontmost Finder window.
function cdf () {
  cd "$(osascript -e 'tell app "Finder" to POSIX path of (insertion location as alias)')"
}

# Find the target of a redirecting URL.
function expandurl () {
# wget -S $1 2>&1 | grep ^Location;
  curl -sIL $1 | grep '^Location' | tail -n 1 | awk '{print $2}'
}

# Change git remote by supplying user/repo.
function gitremote () {
  if [ -d ".git" ] && [ -n "$1" ]; then
    git remote rm origin
    git remote add origin git@github.com:${1}.git
    git config master.remote origin
    git config master.merge refs/heads/master
    echo "Updated git remote to git@github.com:${1}.git"
  else
    echo "Not a git repository."
  fi
}

# Randomize string (space-separated values).
function randomize_string () {
  echo $@ | tr " " "\n" | perl -MList::Util=shuffle -e 'print shuffle(<STDIN>);' | tr "\n" " "
}

# Extract a random item from a string (space-separated values).
function random_el () {
  local array=($(randomize_string $@))
  # Bash $RANDOM is terrible; use jot.
  echo ${array[$(jot -r 1 0 `expr ${#array[*]} - 1`)]}
}

# Set tmux window status using food emoji as index.
if [[ "$TERM" = screen* ]] && [ -n "$TMUX" ]; then
  tmux_index=$(random_el "ğŸº ğŸ¸ ğŸ¹ ğŸ· ğŸ• ğŸ” ğŸŸ ğŸ— ğŸ– ğŸ ğŸ¤ ğŸ£ ğŸ¥ ğŸœ ğŸ¡ ğŸ ğŸ© ğŸ¦ ğŸ¨ ğŸ° ğŸª ğŸ« ğŸ¬ ğŸ­ ğŸ ğŸ ğŸŠ ğŸ‹ ğŸ’ ğŸ‡ ğŸ‰ ğŸ“ ğŸ‘ ğŸŒ ğŸ ğŸ ğŸ† ğŸ…  ")
  tmux set-option quiet on
  tmux set-window window-status-current-format " $tmux_index  #W "
  tmux set-window window-status-format " $tmux_index  #W "
fi
